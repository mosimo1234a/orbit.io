<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Orbit.io - Unlimited Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #f0f0f0; font-family: 'Jua', sans-serif; touch-action: none; }
        #start-screen { position: fixed; inset: 0; background: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        input, button { padding: 12px; font-size: 20px; border: 3px solid #333; border-radius: 8px; font-family: 'Jua'; outline: none; }
        button { background: #333; color: #fff; cursor: pointer; margin-top: 10px; }
        
        #ui { position: fixed; inset: 0; pointer-events: none; z-index: 10; }
        #leaderboard { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.9); border: 3px solid #333; padding: 10px; border-radius: 10px; width: 170px; }
        #my-rank { position: absolute; bottom: 20px; left: 20px; background: #333; color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 18px; pointer-events: auto; }
        
        #chat-box { position: absolute; bottom: 20px; right: 20px; width: 260px; pointer-events: auto; }
        #chat-list { height: 130px; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; }
        .msg { background: #fff; border: 2px solid #333; padding: 4px 10px; border-radius: 8px; margin-top: 4px; font-size: 14px; box-shadow: 2px 2px 0px #333; }
        #chatInput { width: 100%; box-sizing: border-box; margin-top: 8px; border: 3px solid #333; padding: 8px; border-radius: 8px; }
    </style>
</head>
<body>
    <div id="start-screen">
        <h1 style="font-size: 60px; color: #333;">ORBIT.IO</h1>
        <input type="text" id="nickInput" placeholder="ÎãâÎÑ§ÏûÑ ÏûÖÎ†•" maxlength="10">
        <button id="startBtn">Ï†ÑÌà¨ ÏãúÏûë</button>
    </div>

    <div id="ui">
        <div id="leaderboard"><div id="leaderList"></div></div>
        <div id="my-rank">Rank: - / Score: 0</div>
        <div id="chat-box" style="display:none;">
            <div id="chat-list"></div>
            <input type="text" id="chatInput" placeholder="Ï±ÑÌåÖ ÏûÖÎ†• (Enter)">
        </div>
    </div>
    <canvas id="gameCanvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
        const chatInput = document.getElementById('chatInput'), chatList = document.getElementById('chat-list');
        
        let players = {}, targetPlayers = {}, foods = [], firedOrbs = [], myId = null, isStarted = false;
        let camX = 1500, camY = 1500, inX = 0, inY = 0, zoom = 1.0;

        canvas.width = window.innerWidth; canvas.height = window.innerHeight;

        document.getElementById('startBtn').onclick = () => {
            const nick = document.getElementById('nickInput').value.trim() || "ÏùµÎ™Ö";
            socket.emit('join', nick);
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('chat-box').style.display = 'block';
            isStarted = true;
        };

        chatInput.onkeydown = (e) => {
            if (e.key === 'Enter') {
                if (chatInput.value.trim()) socket.emit('sendChat', chatInput.value);
                chatInput.value = ''; chatInput.blur();
            }
            e.stopPropagation();
        };

        socket.on('receiveChat', d => {
            const m = document.createElement('div'); m.className = 'msg';
            m.innerHTML = `<b style="color:${d.color}">${d.nick}:</b> ${d.text}`;
            chatList.appendChild(m);
            if(chatList.children.length > 5) chatList.removeChild(chatList.firstChild);
            setTimeout(() => m.remove(), 6000);
        });

        socket.on('gameState', d => {
            targetPlayers = d.players;
            if (myId && targetPlayers[myId]) {
                if (players[myId]) {
                    players[myId].score = targetPlayers[myId].score;
                    players[myId].radius = targetPlayers[myId].radius;
                }
                document.getElementById('my-rank').innerText = `üèÜ Rank: ${d.myRank}/${d.totalPlayers} | Score: ${Math.floor(targetPlayers[myId].score)}`;
            }
            document.getElementById('leaderList').innerHTML = '<b style="font-size:18px">TOP 5</b>' + d.leaderboard.map((p,i)=>`<div style="font-size:14px; margin-top:3px;">${i+1}. ${p.nickname} (${p.score})</div>`).join('');
        });

        socket.on('initFood', d => foods = d);
        socket.on('updateFood', d => foods = d);
        socket.on('enemyShoot', d => firedOrbs.push(d));
        socket.on('connect', () => myId = socket.id);
        socket.on('gameOver', () => { alert("Í≤åÏûÑ Ïò§Î≤Ñ!"); location.reload(); });

        window.onmousemove = e => { if(document.activeElement !== chatInput) { inX = e.clientX - canvas.width/2; inY = e.clientY - canvas.height/2; }};
        window.onmousedown = e => { if(e.target !== chatInput) shoot(); };

        function shoot() {
            if(!isStarted || !players[myId]) return;
            const a = Math.atan2(inY, inX);
            socket.emit('shoot', { x: players[myId].x, y: players[myId].y, vx: Math.cos(a)*15, vy: Math.sin(a)*15 });
        }

        function loop() {
            ctx.fillStyle = '#f0f0f0'; ctx.fillRect(0,0,canvas.width,canvas.height);

            if (isStarted && targetPlayers[myId]) {
                if (!players[myId]) players[myId] = {...targetPlayers[myId]};
                const me = players[myId];
                const d = Math.hypot(inX, inY);
                if (d > 10) {
                    me.x = Math.max(0, Math.min(3000, me.x + (inX/d)*6));
                    me.y = Math.max(0, Math.min(3000, me.y + (inY/d)*6));
                    socket.emit('move', {x: me.x, y: me.y});
                }
                camX += (me.x - camX) * 0.15; camY += (me.y - camY) * 0.15;

                let targetZoom = 25 / (me.radius * 0.7 + 7);
                targetZoom = Math.max(0.3, Math.min(1.0, targetZoom));
                zoom += (targetZoom - zoom) * 0.05;
            }

            ctx.save(); 
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.scale(zoom, zoom);
            ctx.translate(-camX, -camY);
            
            // Í≤©Ïûê
            ctx.strokeStyle = '#ddd'; ctx.lineWidth = 1/zoom; ctx.beginPath();
            for(let i=0; i<=3000; i+=100) { ctx.moveTo(i,0); ctx.lineTo(i,3000); ctx.moveTo(0,i); ctx.lineTo(3000,i); }
            ctx.stroke();

            // Î®πÏù¥
            foods.forEach(f => {
                ctx.fillStyle = f.color; ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(f.x, f.y, f.radius, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            });

            // ÌîåÎ†àÏù¥Ïñ¥ Î∞è Î¨¥Ï†úÌïú ÏúÑÏÑ±
            for (let id in targetPlayers) {
                if (!players[id]) players[id] = {...targetPlayers[id]};
                const p = players[id]; const target = targetPlayers[id];

                if (id !== myId) {
                    p.x += (target.x - p.x) * 0.3; p.y += (target.y - p.y) * 0.3;
                    p.score = target.score; p.radius = target.radius;
                }

                // Î¨¥Ï†úÌïú ÏúÑÏÑ± Î†åÎçîÎßÅ
                const satCount = Math.floor(p.score); 
                const time = Date.now() / 800;
                for(let j=0; j < satCount; j++) {
                    const angle = time + (j * Math.PI * 2 / satCount);
                    // ÏúÑÏÑ±Ïù¥ ÎßéÏïÑÏßàÏàòÎ°ù Î∞îÍπ•Ï™ΩÏúºÎ°ú Ï∏µÏùÑ ÏåìÏùå
                    const orbitR = p.radius + 25 + (j * 0.05); 
                    ctx.fillStyle = p.color; ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.arc(p.x + orbitR * Math.cos(angle), p.y + orbitR * Math.sin(angle), 6, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                }

                // Î≥∏Ï≤¥
                ctx.fillStyle = p.color; ctx.strokeStyle = '#333'; ctx.lineWidth = 3;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#333'; ctx.textAlign = 'center'; ctx.font = `bold ${14/zoom}px Jua`;
                ctx.fillText(p.nickname, p.x, p.y - p.radius - (12/zoom));
            }

            // Î∞úÏÇ¨Îêú ÌÉÑÌôò
            firedOrbs.forEach((o, i) => {
                o.x += o.vx; o.y += o.vy;
                ctx.fillStyle = o.color; ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(o.x, o.y, 10, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                if (myId && o.ownerId === myId) {
                    for (let id in targetPlayers) {
                        if (id !== myId && Math.hypot(o.x - targetPlayers[id].x, o.y - targetPlayers[id].y) < targetPlayers[id].radius + 10) {
                            socket.emit('hit', id); firedOrbs.splice(i, 1);
                        }
                    }
                }
                if(o.x<0||o.x>3000||o.y<0||o.y>3000) firedOrbs.splice(i,1);
            });

            ctx.restore();
            requestAnimationFrame(loop);
        }
        loop();
        window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    </script>
</body>
</html>