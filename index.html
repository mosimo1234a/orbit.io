<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Orbit.io - Chat Fixed</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #fdfdfd; --border-color: #333; --panel-bg: rgba(255, 255, 255, 0.9); }
        body { margin: 0; overflow: hidden; background: var(--bg-color); font-family: 'Jua', sans-serif; touch-action: none; }
        
        #ui { position: fixed; inset: 0; pointer-events: none; z-index: 10; }
        
        /* Ï±ÑÌåÖÏ∞Ω Î†àÏù¥ÏïÑÏõÉ: 15Í∞ú ÎàÑÏ†ÅÏö© */
        #chat-box { position: absolute; top: 10px; left: 10px; width: 220px; pointer-events: auto; }
        #chat-list { 
            height: 200px; 
            overflow-y: hidden; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-end; 
            margin-bottom: 5px; 
        }
        .msg { 
            background: var(--panel-bg); border: 2.5px solid var(--border-color); 
            padding: 5px 12px; border-radius: 12px; margin-top: 3px; 
            font-size: 13px; color: #333; box-shadow: 2px 2px 0 rgba(0,0,0,0.05);
            animation: pop 0.2s ease-out;
        }
        @keyframes pop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        #chatInput { 
            width: 100%; border: 3px solid var(--border-color); padding: 10px; 
            border-radius: 12px; font-size: 14px; box-sizing: border-box; background: #fff;
            outline: none; font-family: 'Jua';
        }

        #leaderboard { position: absolute; top: 10px; right: 10px; background: var(--panel-bg); border: 3px solid var(--border-color); padding: 10px; border-radius: 12px; width: 150px; font-size: 13px; }
        #my-rank { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); background: var(--border-color); color: #fff; padding: 6px 18px; border-radius: 20px; font-size: 14px; }
        #mobile-shoot { position: fixed; bottom: 20px; right: 20px; width: 80px; height: 80px; background: #ff8e8e; border: 4px solid var(--border-color); border-radius: 50%; color: white; font-size: 18px; z-index: 20; display: none; justify-content: center; align-items: center; box-shadow: 0 5px 0 var(--border-color); }

        #start-screen { position: fixed; inset: 0; background: var(--bg-color); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        input, button { padding: 12px 20px; font-size: 18px; border: 3px solid var(--border-color); border-radius: 15px; font-family: 'Jua'; margin-bottom: 10px; }
        button { background: #ffcc00; cursor: pointer; border-bottom-width: 6px; }

        @media (min-width: 768px) {
            #chat-box { width: 300px; top: auto; bottom: 20px; left: auto; right: 20px; }
            #my-rank { bottom: 25px; left: 25px; transform: none; }
        }
    </style>
</head>
<body>
    <div id="start-screen">
        <h1>ORBIT.IO</h1>
        <input type="text" id="nickInput" placeholder="NICKNAME" maxlength="10">
        <button id="startBtn">START</button>
    </div>

    <div id="ui">
        <div id="leaderboard"><div id="leaderList"></div></div>
        <div id="my-rank">Rank: - / Score: 0</div>
        <div id="chat-box" style="display:none;">
            <div id="chat-list"></div>
            <input type="text" id="chatInput" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†• ÌõÑ ÏóîÌÑ∞">
        </div>
    </div>
    
    <div id="mobile-shoot">FIRE!</div>
    <canvas id="gameCanvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
        const chatInput = document.getElementById('chatInput'), chatList = document.getElementById('chat-list');
        const mobileShoot = document.getElementById('mobile-shoot');
        
        let players = {}, targetPlayers = {}, foods = [], firedOrbs = [], myId = null, isStarted = false;
        let camX = 1500, camY = 1500, inX = 0, inY = 0, zoom = 1.0;

        canvas.width = window.innerWidth; canvas.height = window.innerHeight;

        document.getElementById('startBtn').onclick = () => {
            socket.emit('join', document.getElementById('nickInput').value.trim() || "Guest");
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('chat-box').style.display = 'block';
            if(window.innerWidth < 768) mobileShoot.style.display = 'flex';
            isStarted = true;
        };

        // Ï±ÑÌåÖ Í∏∞Îä• Î≥¥Í∞ï (ÏóîÌÑ∞ÌÇ§ Ïù¥Î≤§Ìä∏)
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const msg = chatInput.value.trim();
                if (msg) {
                    socket.emit('chat', msg); // ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°
                    chatInput.value = ''; // ÏûÖÎ†•Ï∞Ω ÎπÑÏö∞Í∏∞
                }
                chatInput.blur(); // Ìè¨Ïª§Ïä§ Ìï¥Ï†ú
            }
        });

        // ÏÑúÎ≤ÑÎ°úÎ∂ÄÌÑ∞ Ï±ÑÌåÖ Î∞õÍ∏∞
        socket.on('chat', (data) => {
            const m = document.createElement('div');
            m.className = 'msg';
            m.innerHTML = `<b>${data.nick}:</b> ${data.msg}`;
            chatList.appendChild(m);
            
            // 15Í∞ú ÎàÑÏ†Å Ïú†ÏßÄ
            while (chatList.children.length > 15) {
                chatList.removeChild(chatList.firstChild);
            }
        });

        function handleInput(x, y) {
            if(document.activeElement === chatInput) return;
            inX = x - canvas.width/2; inY = y - canvas.height/2;
        }

        window.addEventListener('mousemove', e => handleInput(e.clientX, e.clientY));
        window.addEventListener('touchmove', e => {
            if (isStarted && document.activeElement !== chatInput) e.preventDefault();
            handleInput(e.touches[0].clientX, e.touches[0].clientY);
        }, {passive: false});

        function shoot() {
            if(!isStarted || !players[myId]) return;
            const a = Math.atan2(inY, inX);
            socket.emit('shoot', { x: players[myId].x, y: players[myId].y, vx: Math.cos(a)*15, vy: Math.sin(a)*15 });
        }

        window.onmousedown = e => { if(isStarted && e.target === canvas) shoot(); };
        mobileShoot.ontouchstart = e => { e.preventDefault(); shoot(); };

        socket.on('gameState', d => {
            targetPlayers = d.players;
            if (myId && targetPlayers[myId]) {
                document.getElementById('my-rank').innerText = `üèÜ Rank: ${d.myRank}/${d.totalPlayers} | Score: ${Math.floor(targetPlayers[myId].score)}`;
            }
            document.getElementById('leaderList').innerHTML = '<b style="border-bottom:2px solid #333; display:block; margin-bottom:5px;">RANKING</b>' + 
                d.leaderboard.map((p,i)=>`<div style="color:${p.color}">${i+1}. ${p.nickname} (${Math.floor(p.score)})</div>`).join('');
        });

        socket.on('initFood', d => foods = d);
        socket.on('updateFood', d => foods = d);
        socket.on('enemyShoot', d => firedOrbs.push(d));
        socket.on('connect', () => myId = socket.id);

        function drawCircle(x, y, r, color, sW = 3) {
            ctx.fillStyle = color; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#333'; ctx.lineWidth = sW; ctx.stroke();
        }

        function loop() {
            ctx.fillStyle = '#fdfdfd'; ctx.fillRect(0,0,canvas.width,canvas.height);
            
            // Î∞∞Í≤Ω Í∑∏Î¶¨Îìú
            ctx.strokeStyle = "#eee"; ctx.lineWidth = 1; ctx.beginPath();
            let gS = 50 * zoom;
            let oX = (canvas.width/2 - camX*zoom) % gS;
            let oY = (canvas.height/2 - camY*zoom) % gS;
            for(let x=oX; x<canvas.width; x+=gS) { ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); }
            for(let y=oY; y<canvas.height; y+=gS) { ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); }
            ctx.stroke();

            if (isStarted && targetPlayers[myId]) {
                if (!players[myId]) players[myId] = {...targetPlayers[myId]};
                const me = players[myId];
                const d = Math.hypot(inX, inY);
                if (d > 10) {
                    me.x = Math.max(0, Math.min(3000, me.x + (inX/d)*6));
                    me.y = Math.max(0, Math.min(3000, me.y + (inY/d)*6));
                    socket.emit('move', {x: me.x, y: me.y});
                }
                me.radius = targetPlayers[myId].radius;
                me.score = targetPlayers[myId].score;

                camX += (me.x - camX) * 0.15; camY += (me.y - camY) * 0.15;
                let tZ = 25 / (me.radius * 0.7 + 7);
                tZ = Math.max(window.innerWidth < 768 ? 0.45 : 0.3, Math.min(1.0, tZ));
                zoom += (tZ - zoom) * 0.05;
            }

            ctx.save(); 
            ctx.translate(canvas.width/2, canvas.height/2); ctx.scale(zoom, zoom); ctx.translate(-camX, -camY);
            
            foods.forEach(f => drawCircle(f.x, f.y, f.radius, f.color, 1.5));

            for (let id in targetPlayers) {
                const p = players[id] || targetPlayers[id];
                p.radius = targetPlayers[id].radius;
                p.score = targetPlayers[id].score;
                if (id !== myId) {
                    p.x += (targetPlayers[id].x - p.x) * 0.3;
                    p.y += (targetPlayers[id].y - p.y) * 0.3;
                }
                
                const sC = Math.floor(p.score);
                for(let j=0; j < sC; j++) {
                    const ang = (Date.now() / 800) + (j * Math.PI * 2 / Math.max(1, sC));
                    const oR = p.radius + 25 + (j * 0.5);
                    drawCircle(p.x + oR * Math.cos(ang), p.y + oR * Math.sin(ang), 6, p.color, 2);
                }
                drawCircle(p.x, p.y, p.radius, p.color, 4);
                ctx.fillStyle = "#333"; ctx.textAlign = "center"; ctx.font = "bold 16px Jua";
                ctx.fillText(targetPlayers[id].nickname, p.x, p.y + p.radius + 30);
            }
            firedOrbs.forEach(o => drawCircle(o.x += o.vx, o.y += o.vy, 10, o.color, 2));
            ctx.restore();
            requestAnimationFrame(loop);
        }
        loop();
        window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    </script>
</body>
</html>